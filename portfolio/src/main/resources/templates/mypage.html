<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio OTA</title>
</head>

<body>
  <!-- header挿入 -->
  <header th:insert="fragments/header::header"></header>
  <main role="main">
    <div class="container text-center mt-5">
      <div class="d-flex justify-content-center align-items-center mb-5">
        <h2 class="page-title text-center mb-">My Page</h2>
        <!-- <form th:action="@{/portfolio/history}" method="GET" class="form-inline">
        <button class="btn btn-warning m-3">See history</button>
      </form> -->
      </div>
      <div class="container-fluid mb-5 table-responsive-md">
        <form th:action="@{/portfolio/user/modify}" method="post" enctype="multipart/form-data">
          <table class="table table-hover table-bordered table-responsive-md text-center" th:object="${user}">
            <tr>
              <th scope="row" class="img-column">Profile Picture</th>
              <td style="position: relative;">
                <img th:src="@{{imagePath} (imagePath = *{userImg})}"
                  th:class="${user.getUserImg().isEmpty() ? 'hidden' : 'mypage-img'}">
                <img src="/img/avator.png" alt="" th:class="${user.getUserImg().isEmpty() ? 'mypage-img' : 'hidden'}">
                <form class="" th:action="@{/portfolio/user/imgRegis}" method="post" enctype="multipart/form-data">
                  <label id="file-btn" for="userImg" class="bg-primary text-white">Choose your photo</label>
                  <input type="file" name="file" id="userImg" style="display: none;">
                  <p id="selected-status" class="mt-1">Not yet selcted</p>
                  <!-- <button id="upload-btn" type="submit" class="btn btn-info hidden">Start Upload</button> -->
                </form>
              </td>
            </tr>
            <tr>
              <th scope="row" style="width: 30%;">User Name</th>
              <td class="normal">
                <span th:text="*{userName}"></span>
              </td>
              <td class="modify hidden">
                <span><input type="text" name="userName" th:value="*{userName}" th:placeholder="*{userName}"
                    style="width: 40%;"></span>
              </td>
            </tr>
            <tr>
              <th scope="row" style="width: 30%;">Full Name</th>
              <td class="normal">
                <span th:text="*{familyName}"></span><span th:text="*{firstName}"></span>
              </td>
              <td class="modify hidden">
                <span><input type="text" name="familyName" th:value="*{familyName}" th:placeholder="*{familyName}"
                    style="width: 20%;"></span>
                <span><input type="text" name="firstName" th:value="*{firstName}" th:placeholder="*{firstName}"
                    style="width: 20%;"></span>
              </td>
            </tr>
            <tr>
              <th scope="row" style="width: 30%;">Password</th>
              <td class="normal">
                <span id="asters"></span>
              </td>
              <td class="modify hidden">
                <span><input type="password" name="password" id="newPassword" th:value="*{password}"
                    placeholder="******" style="width: 40%;"></span>
              </td>
            </tr>
            <tr>
              <th scope="row" style="width: 30%;">E-mail</th>
              <th class="normal">
                <span id="email" th:text="*{email}"></span>
              </th>
              <th class="modify hidden">
                <span><input type="email" name="email" id="newEmail" th:value="*{email}" th:placeholder="*{email}"
                    style="width: 40%;"></span>
              </th>
            </tr>
            <tr>
              <th scope="row" style="width: 30%;">Gender</th>
              <td th:text="*{gender == 'M' ? 'Male' : 'Female'}"></td>
            </tr>
          </table>
          <div class="btn-area">
            <button id="modify-btn" class="btn btn-info" type="button">Modify</button>
            <button id="cancel-btn" class="btn btn-warning hidden" type="button">Cancel</button>
            <button id="submit-btn" class="btn btn-primary hidden" type="submit">Submit</button>
          </div>
          <!-- </form> -->
      </div>
    </div>
  </main>
  <!-- footer -->
  <footer th:insert="fragments/footer::footer"></footer>

  <script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    /* 実際のパスワードの文字数分 「●」 を表示する */
    $(document).ready(function () {

      // パスワードのマスク
      let password = /*[[${user.password}]]*/ 'password';
      let asters = '';
      for (let i = 0; i < password.length; i++) {
        asters += '●';
      }
      $('#asters').text(asters);

      $('#userImg').change(function () {
        var file = $(this).prop('files')[0];
        $('#selected-status').text(file.name);
        // $('#upload-btn').removeClass('hidden');
        // $('#upload-btn').on('click', function (e) {
          const fd = new FormData();
          fd.append('file', $('input[type=file]')[0].files[0]);
          $.ajax({
            url: '/portfolio/user/imgRegis',
            type: "POST",
            data: fd,
            enctype: 'multipart/form-data',
            processData: false,
            contentType: false,
            cache: false
          }).done(function (bool) {
            if (bool == true) {
              bootbox.alert({
                message: 'Your photo has just changed now!',
                backdrop: true,
                centerVertical: true,
                callback: function () {
                  location.reload();
                }
              })
            }
            console.log('画像ファイルをimgフォルダに格納しました');
          }).fail(function () {
            console.log('Error: ajax通信に失敗しました');
          }).always(function (result) {
            console.log("ajax通信しました");
          })
        // })
      });

      $('#modify-btn').on('click', function () {
        $('.normal').addClass('hidden');
        $('.modify').removeClass('hidden');
        $('#modify-btn').addClass('hidden');
        $('#cancel-btn').removeClass('hidden');
        $('#submit-btn').removeClass('hidden');
      });
      $('#cancel-btn').on('click', function () {
        $('.normal').removeClass('hidden');
        $('.modify').addClass('hidden');
        $('#modify-btn').removeClass('hidden');
        $('#cancel-btn').addClass('hidden');
        $('#submit-btn').addClass('hidden');
      });

    });

    /*]]>*/
  </script>
</body>

</html>
