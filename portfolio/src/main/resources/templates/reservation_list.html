<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portfolio OTA</title>
</head>

<body>
  <!-- header挿入 -->
  <header th:insert="fragments/header::header"></header>
  <main role="main">
    <!-- mypgae -->
    <section id="reservation-info">
      <div class="page-content page-container" id="page-content">
        <div class="padding">
          <div class="row container-fluid justify-content-center">
            <div class="page-title-area d-flex justify-content-center">
              <h2 th:class="${reservationList.size() > 0 ? 'hidden' : 'page-title'}">You have no reservation</h2>
              <h2 th:class="${reservationList.size() > 0 ? 'page-title' : 'hidden'}">Your Reservation</h2>
            </div>
            <div class="col-lg-12 grid-margin stretch-card owl-carousel owl-theme">
              <div class="card" th:each="reservation:${reservationList}" th:object=${reservation}
                th:if="${reservationList.size() > 0}">
                <img th:src="@{{imagePath} (imagePath = *{productImage})}" alt="" class="card-img-top">
                <a id="detail-btn" th:href="@{/portfolio/product/{productId} (productId=*{productId})}"
                  class="btn btn-primary">See detail</a>
                <div class="card-body">
                  <dl>
                    <div class="reserve-info">
                      <dt class="card-text">Product Name:</dt>&nbsp;<dd th:text="*{productName}"></dd>
                    </div>
                    <div class="reserve-info">
                      <dt class="card-text">Unit Price:</dt>&nbsp;<dd th:text="*{price}"></dd>
                    </div>
                    <div class="reserve-info">
                      <dt class="card-text">Date:</dt>&nbsp;<dd th:text="*{date}"></dd>
                    </div>
                    <div class="reserve-info">
                      <dt class="card-text">Participant Number:</dt>&nbsp;<dd th:text="*{count}"></dd>
                    </div>
                    <div class="reserve-info">&nbsp;
                      <dt class="card-text">Total Amount:</dt>&nbsp;<span>$</span>
                      <dd th:text="*{price * count}"></dd>
                    </div>
                  </dl>
                  <div class="btn-area d-flex">
                    <button type="button" class="btn btn-primary payment-btn mx-2">Payment</button>
                    <button type="button" class="btn btn-primary delete-btn mx-2">Delete</button>
                    <input type="hidden" class="reservationId" name="reservationId" th:value="*{id}">
                  </div>
                </div>
              </div><!-- card -->
            </div><!-- col -->
          </div><!-- row -->
          <input type="hidden" id="email" name="email" th:value="${email}">
        </div>
    </section>
  </main>
  <!-- footer -->
  <footer th:insert="fragments/footer::footer"></footer>

  <script type="text/javascript" th:inline="javascript">
    /*<![CDATA[*/
    $(document).ready(function () {

      /* 削除ボタン押下時*/
      $('.delete-btn').on('click', function (e) {
        bootbox.confirm({
          message: "Are you sure to delete this reservation?",
          backdrop: true,
          centerVertical: true,
          buttons: {
            confirm: {
              label: '<i class="fa fa-check"></i> Yes',
              className: 'btn-primary'
            },
            cancel: {
              label: '<i class="fa fa-times"></i> Cancel',
              className: 'btn-secondary'
            }
          },
          callback: function (result) {
            if (result) {
              let id = $(e.target).parent().find('.reservationId').val();
              $.ajax({
                type: 'POST',
                url: '/portfolio/reservation/delete',
                data: id,
                contentType: 'application/json',
                dataType: 'json',
              }).done(function (bool) {
                if (bool) {
                  bootbox.alert({
                    message: 'This reservation was deleted.',
                    backdrop: true,
                    centerVertical: true,
                    callback: function () {
                      location.replace('/portfolio/reservation');
                    }
                  })
                } else {
                  bootbox.alert('Something wrong, could not delete. Please try agin');
                }
              }).fail(function () {
                console.log('ajax通信に失敗しました');
              }).always(function () {
                console.log('ajax通信しました');
              });
            } else {
              console.log('✖️ボタンが押されました');
            }
          }
        })
      })

      $('.payment-btn').on('click', function () {
        var box = bootbox.confirm({
          message: "<p>We will send you a payment link to this email.</p>\
                    <p>Please confirm this email is correct</p>\
                    <p>[<span id='conf-email'></span>]</p>",
          backdrop: true,
          centerVertical: true,
          show: true,
          buttons: {
            confirm: {
              label: '<i class="fa fa-check"></i> Submit',
              className: 'btn-primary'
            },
            cancel: {
              label: '<i class="fa fa-times"></i> Modify',
              className: 'btn-secondary'
            }
          },
          callback: function (result) {
            if (result) {
              let email = $('#email').val();
              $.ajax({
                type: 'POST',
                url: '/portfolio/reservation/sendEmail',
                data: email,
                contentType: 'application/json',
                dataType: 'json'
              }).done(function (result) {
                if (result == true) {
                  bootbox.alert('We sent an eamil to you. Please check it out!');
                } else {
                  bootbox.alert('Something wrong. Please try again.')
                }
              }).fail(function (result) {
                console.log('Error: ajax通信に失敗しました');
              }).always(function (result) {
                console.log("ajax通信しました");
              })
            }
          }, // callback
        })
        box.on("shown.bs.modal", function () {
          $('#conf-email').text($('#email').val());
        })
      })


      $('.owl-carousel').owlCarousel({
        loop: true,
        margin: 10,
        responsive: {
          0: {
            items: 1
          }
        }
      });
    });
  /*]]>*/
  </script>
</body>

</html>
